services:
  openminer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # 預設 0：容器會跑得起 UI/API，但未必有真 MinerU OCR（會走你現有的 fallback/模擬）。
        # 想要把 MinerU CLI 也裝入 image，就改成 1（build 會重一點）。
        INSTALL_MINERU: "1"
    ports:
      - "${OPENMINER_HOST_PORT:-8001}:8000"
    # 明確指定單一 worker（WebSocket 進度用記憶體管理，多 worker 會導致前後端進度不同步）
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]
    # 把專案根目錄的 .env 注入容器環境變數（注意：.env 目前被 .dockerignore 排除，不會被 COPY 入 image）
    env_file:
      - .env
    environment:
      APP_HOST: "0.0.0.0"
      APP_PORT: "8000"
      DEBUG: "True"

      # CPU 預設：避免誤觸 vLLM（需要 NVIDIA/CUDA）
      USE_VLLM_ASYNC: "False"
      MINERU_DEVICE: "cpu"

      # 可選：你可以喺 .env 或 compose 覆蓋
      # JSON_GENERATION_METHOD: "program_json"  # legacy: program_csv
      # MINERU_OUTPUT_SOURCE: "json"
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
      - ./mineru_outputs:/app/mineru_outputs
      - ./sharepoint_downloads:/app/sharepoint_downloads
