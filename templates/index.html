<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMiner™</title>
    <link rel="icon" type="image/png" href="/static/OpenMiner.png">
    <link rel="alternate icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --accent-teal: #22c1c3;
            --accent-coral: #ff6a88;
            --accent-amber: #fbbf24;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-gradient: linear-gradient(
                135deg,
                #070a1f 0%,
                #0b1232 22%,
                #151a38 45%,
                #0a1b24 70%,
                #070a12 100%
            );
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding: 12px;
            position: relative;
            overflow-x: hidden;
        }

        /* Subtle multi-color glow (kept tasteful) */
        body::after {
            content: '';
            position: fixed;
            inset: -20%;
            background:
                radial-gradient(700px 500px at 15% 25%, rgba(34, 193, 195, 0.28), transparent 60%),
                radial-gradient(800px 560px at 85% 20%, rgba(255, 106, 136, 0.22), transparent 62%),
                radial-gradient(900px 620px at 70% 85%, rgba(102, 126, 234, 0.22), transparent 60%),
                radial-gradient(700px 520px at 20% 85%, rgba(251, 191, 36, 0.18), transparent 64%),
                conic-gradient(from 210deg at 50% 50%, rgba(118, 75, 162, 0.08), rgba(34, 193, 195, 0.08), rgba(255, 106, 136, 0.08), rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            filter: blur(40px) saturate(1.2);
            opacity: 0.85;
            pointer-events: none;
            z-index: 1;
            mix-blend-mode: screen;
            animation: glowFloat 14s ease-in-out infinite;
        }

        @keyframes glowFloat {
            0% { transform: translate3d(0, 0, 0) scale(1); }
            50% { transform: translate3d(2%, -1.5%, 0) scale(1.03); }
            100% { transform: translate3d(0, 0, 0) scale(1); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* SharePoint tree view */
        .sp-tree {
            background: rgba(255,255,255,0.55);
            border-radius: 12px;
            padding: 12px;
            font-size: 13px;
            max-height: 420px;
            overflow: auto;
        }

        .sp-tree details {
            margin-left: 14px;
        }

        .sp-tree details[open] > summary::before {
            content: '▾';
            display: inline-block;
            width: 18px;
            color: rgba(17, 24, 39, 0.65);
            font-weight: 800;
        }

        .sp-tree details:not([open]) > summary::before {
            content: '▸';
            display: inline-block;
            width: 18px;
            color: rgba(17, 24, 39, 0.65);
            font-weight: 800;
        }

        .sp-tree summary {
            list-style: none;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 8px;
            user-select: none;
        }

        .sp-tree summary::-webkit-details-marker {
            display: none;
        }

        .sp-tree summary:hover {
            background: rgba(37, 99, 235, 0.07);
        }

        .sp-tree .sp-tree-folder {
            color: #2563eb;
            text-decoration: none;
            font-weight: 800;
        }

        .sp-tree .sp-tree-folder:hover {
            text-decoration: underline;
        }

        .sp-tree .sp-tree-files {
            margin: 4px 0 6px 32px;
            display: grid;
            gap: 2px;
        }

        .sp-tree .sp-tree-file {
            opacity: 0.9;
            padding: 2px 0;
        }

        /* Starfield background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.8), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.6), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.9), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.7), transparent),
                radial-gradient(2px 2px at 90% 40%, rgba(255, 255, 255, 0.5), transparent),
                radial-gradient(1px 1px at 33% 60%, rgba(255, 255, 255, 0.8), transparent),
                radial-gradient(2px 2px at 10% 80%, rgba(255, 255, 255, 0.6), transparent),
                radial-gradient(1px 1px at 70% 90%, rgba(255, 255, 255, 0.7), transparent);
            background-size: 200% 200%;
            background-position: 0% 0%;
            animation: starMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes starMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            padding: 18px;
            position: relative;
            z-index: 2;
            animation: slideUp 0.6s ease-out;
        }

        /* Ensure form controls and textareas don't force horizontal scrolling */
        input[type="text"], input[type="file"], select, textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .form-group {
            display: block;
            margin-bottom: 12px;
        }

        /* Responsive adjustments for smaller laptop screens (14" and similar) */
        @media (max-width: 1366px) {
            .container {
                max-width: 920px;
            }
        }

        @media (max-width: 1024px) {
            .container {
                margin: 8px;
                padding: 12px;
                border-radius: 12px;
            }
            .header .title {
                font-size: 1.1rem;
            }
        }

        /* Thin colorful border on glass card (more polished) */
        .container::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            padding: 1px;
            background: linear-gradient(
                135deg,
                rgba(34, 193, 195, 0.45) 0%,
                rgba(102, 126, 234, 0.45) 35%,
                rgba(255, 106, 136, 0.40) 70%,
                rgba(251, 191, 36, 0.35) 100%
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0.8;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 14px;
        }

        h1 {
            background: linear-gradient(135deg, #667eea 0%, #22c1c3 35%, #ff6a88 70%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 15px;
            letter-spacing: -1px;
            animation: fadeInDown 0.8s ease-out;
        }

        .subtitle {
            color: #64748b;
            font-size: 0.9em;
            font-weight: 400;
            max-width: 920px;
            margin: 0 auto;
            line-height: 1.35;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            animation: fadeInDown 0.8s ease-out 0.2s both;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 50%, #fef3f2 100%);
            padding: 8px;
            border-radius: 12px;
            position: relative;
        }

        /* Desktop: make header a topbar (saves above-the-fold space) */
        @media (min-width: 900px) {
            .header {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 18px;
                text-align: center;
                margin-bottom: 12px;
            }

            .logo {
                margin-bottom: 0;
            }

            .subtitle {
                display: none;
            }
        }

        .tab {
            flex: 1;
            padding: 10px 14px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
            z-index: 1;
        }

        .tab:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }

        .tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent-teal) 45%, var(--secondary) 100%);
            box-shadow: 0 10px 22px rgba(102, 126, 234, 0.28), 0 6px 14px rgba(34, 193, 195, 0.18);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-area {
            border: 3px dashed rgba(102, 126, 234, 0.85);
            border-radius: 20px;
            padding: 26px 18px;
            min-height: 150px;
            text-align: center;
            background:
                radial-gradient(circle at 15% 20%, rgba(34, 193, 195, 0.10), transparent 50%),
                radial-gradient(circle at 85% 25%, rgba(255, 106, 136, 0.10), transparent 55%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.06) 0%, rgba(118, 75, 162, 0.06) 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-bg-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6.5em;
            color: rgba(102, 126, 234, 0.18);
            z-index: 0;
            pointer-events: none;
            opacity: 0.65;
        }

        .upload-area:hover {
            border-color: rgba(34, 193, 195, 0.95);
            background:
                radial-gradient(circle at 15% 20%, rgba(34, 193, 195, 0.14), transparent 52%),
                radial-gradient(circle at 85% 25%, rgba(255, 106, 136, 0.12), transparent 55%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.10) 0%, rgba(118, 75, 162, 0.10) 100%);
            transform: translateY(-5px);
            box-shadow: 0 14px 40px rgba(102, 126, 234, 0.16), 0 10px 26px rgba(34, 193, 195, 0.12);
        }

        .upload-area.dragover {
            border-color: rgba(255, 106, 136, 0.95);
            background:
                radial-gradient(circle at 20% 30%, rgba(255, 106, 136, 0.16), transparent 52%),
                radial-gradient(circle at 80% 35%, rgba(34, 193, 195, 0.14), transparent 55%),
                linear-gradient(135deg, rgba(102, 126, 234, 0.14) 0%, rgba(118, 75, 162, 0.14) 100%);
            transform: scale(1.02);
            box-shadow: 0 18px 52px rgba(255, 106, 136, 0.14), 0 14px 40px rgba(102, 126, 234, 0.18);
        }

        .upload-icon {
            font-size: 3.2em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent-teal) 40%, var(--accent-coral) 75%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: bounce 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            position: relative;
            z-index: 1;
        }

        .upload-hint {
            color: #64748b;
            font-size: 0.95em;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .upload-details {
            margin-top: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
        }

        .upload-details summary {
            cursor: pointer;
            font-weight: 600;
            color: #334155;
            list-style: none;
        }

        .upload-details summary::-webkit-details-marker {
            display: none;
        }

        .upload-details .upload-details-body {
            margin-top: 10px;
            font-size: 0.95em;
            line-height: 1.75;
            color: #64748b;
        }

        input[type="file"] {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #1e293b;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="url"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-group:hover {
            background: #f1f5f9;
            transform: translateX(5px);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent-teal) 40%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 13px 28px;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 26px rgba(102, 126, 234, 0.22), 0 6px 16px rgba(34, 193, 195, 0.14);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 42px rgba(102, 126, 234, 0.24), 0 10px 26px rgba(34, 193, 195, 0.16);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .progress {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, #f093fb 100%);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            will-change: width;
            overflow: hidden;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            background-size: 200% 100%;
            animation: flowWave 7s linear infinite;
        }

        @keyframes flowWave {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .progress-text {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            color: #334155;
            font-weight: 600;
            font-size: 0.95em;
        }

        .progress-text .progress-percent {
            margin-left: auto;
            color: #64748b;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }


        .result {
            display: none;
            margin-top: 30px;
            padding: 25px;
            border-radius: 16px;
            border-left: 5px solid;
            animation: slideIn 0.4s ease-out;
            backdrop-filter: blur(10px);
            overflow-x: hidden;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .result.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-left-color: var(--success);
            color: #065f46;
        }

        .result.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left-color: var(--error);
            color: #991b1b;
        }

        .result-title {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-content {
            color: inherit;
            margin-bottom: 15px;
            line-height: 1.6;
            opacity: 0.9;
            overflow-x: hidden;
            overflow-y: auto;
            max-height: 60vh;
            padding-right: 6px;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
            margin-top: 10px;
        }

        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .file-info {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            font-size: 0.95em;
            color: #475569;
            line-height: 1.8;
            animation: fadeIn 0.3s;
        }

        .file-info strong {
            color: #1e293b;
            font-weight: 600;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 18px 14px;
            }

            h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }

            .upload-area {
                padding: 22px 12px;
                min-height: 140px;
            }

            .upload-icon {
                font-size: 3.1em;
            }

            .logo {
                gap: 12px;
                margin-bottom: 10px;
            }

            .logo-svg {
                width: 76px;
                height: 76px;
            }

            .logo-text {
                font-size: 1.9em;
            }

            .subtitle {
                font-size: 0.92em;
            }
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            max-width: 1200px;
            margin: 40px auto 0;
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            position: relative;
            z-index: 2;
        }

        .footer-text {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 12px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .logo-svg {
            width: clamp(66px, 7vw, 86px);
            height: clamp(66px, 7vw, 86px);
            animation: none;
            filter: drop-shadow(0 14px 26px rgba(102, 126, 234, 0.22)) drop-shadow(0 10px 18px rgba(34, 193, 195, 0.14));
        }

        .logo-img {
            width: clamp(66px, 7vw, 86px);
            height: clamp(66px, 7vw, 86px);
            animation: none;
            filter: drop-shadow(0 14px 26px rgba(102, 126, 234, 0.22)) drop-shadow(0 10px 18px rgba(34, 193, 195, 0.14));
            display: block;
            object-fit: contain;
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-8px) rotate(8deg);
            }
        }

        .logo-text {
            font-size: clamp(1.6em, 3.1vw, 2.05em);
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #22c1c3 35%, #ff6a88 70%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img class="logo-img" src="/static/OpenMiner.png" alt="OpenMiner" />
                <span class="logo-text">OpenMiner™</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">
                <i class="fas fa-upload"></i> Upload
            </button>
            <button class="tab" onclick="switchTab('sharepoint')">
                <i class="fas fa-cloud"></i> SharePoint
            </button>
            <button class="tab" onclick="switchTab('folder')">
                <i class="fas fa-folder"></i> Windows Folder
            </button>
        </div>

        <!-- Upload tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-area" id="uploadArea" onclick="openFilePicker()">
                <i class="fas fa-file-pdf upload-bg-icon"></i>
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Click or drag &amp; drop files here</div>
                <div class="upload-hint">Supports PDF or JSON (multi-select / batch)</div>
            </div>
            <div style="display:flex; gap:10px; margin-top: 10px;">
                <button class="btn" type="button" onclick="openFilePicker()" style="flex:1; padding: 12px 14px;">
                    <span><i class="fas fa-file-arrow-up"></i> Choose files (multi-select)</span>
                </button>
                <button class="btn" type="button" onclick="openFolderPicker()" style="flex:1; padding: 12px 14px;">
                    <span><i class="fas fa-folder-open"></i> Choose folder</span>
                </button>
            </div>

            

            <!-- NOTE: Avoid display:none; some browsers ignore programmatic click() on hidden file inputs. -->
            <input type="file" id="fileInput" accept=".pdf,.json" multiple style="position:absolute; left:-10000px; width:1px; height:1px; opacity:0;" />
            <input type="file" id="folderInput" accept=".pdf,.json" webkitdirectory directory multiple style="position:absolute; left:-10000px; width:1px; height:1px; opacity:0;" />
            <div class="file-info" id="fileInfo" style="display: none;"></div>
            <!-- CSV options removed: outputs are JSON only -->
            <div class="form-group">
                <label for="systemPromptInput">System Prompt (optional override; can also be saved as default)</label>
                <textarea id="systemPromptInput" rows="20" style="min-height:72px; width:100%;" placeholder="Leave blank to use defaults or .env settings"></textarea>
            </div>
            <div class="form-group">
                <label for="userPromptInput">User Prompt (optional override; can also be saved as default)</label>
                <textarea id="userPromptInput" rows="3" style="min-height:72px; width:100%;" placeholder="Leave blank to use defaults or .env settings"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top: 8px;">
                <button class="btn" type="button" onclick="loadPromptDefaults()" style="flex:1; padding: 12px 14px;">
                    <span><i class="fas fa-rotate"></i> Load defaults (.env)</span>
                </button>
                <button class="btn" type="button" onclick="savePromptDefaults()" style="flex:1; padding: 12px 14px;">
                    <span><i class="fas fa-floppy-disk"></i> Save as defaults (.env)</span>
                </button>
            </div>
            <div id="promptStatusBox" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; font-size:13px;"></div>
            <button class="btn" onclick="uploadFile()" id="uploadBtn" disabled>
                <span><i class="fas fa-magic"></i> Process</span>
            </button>
        </div>

        <!-- SharePoint tab -->
        <div id="sharepoint-tab" class="tab-content">
            <details class="upload-details" style="margin-top: 0;">
                <summary><i class="fas fa-gear"></i> SharePoint connection settings</summary>
                <div class="upload-details-body">
                    <div class="form-group">
                        <label for="spClientId"><i class="fas fa-id-badge"></i> Client ID</label>
                        <input type="text" id="spClientId" placeholder="Azure AD App (client) ID" />
                    </div>
                    <div class="form-group">
                        <label for="spTenant"><i class="fas fa-building"></i> Tenant</label>
                        <input type="text" id="spTenant" placeholder="Tenant ID (GUID) or name" />
                    </div>
                    <div class="form-group">
                        <label for="spSecret"><i class="fas fa-key"></i> Secret <span id="spSecretStatus" style="font-weight:600; opacity:.8;"></span></label>
                        <input type="password" id="spSecret" placeholder="Paste the client secret VALUE here (leave blank to keep current)" autocomplete="new-password" />
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
                            Secret is write-only for safety. Leave blank to keep the current value.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="spLink"><i class="fas fa-link"></i> Site/Library Link (reference)</label>
                        <input type="text" id="spLink" placeholder="e.g.: https://tenant.sharepoint.com/sites/SiteName/Shared Documents/Forms/AllItems.aspx" />
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
                            This is not the file to process. It helps derive the SharePoint site URL.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="spDefaultFolder"><i class="fas fa-folder"></i> Default folder (auto-processing target)</label>
                        <input type="hidden" id="spDefaultFolder" value="" />
                        <div style="display:flex; gap:14px; flex-wrap:wrap; margin-top: 8px;">
                            <label style="display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
                                <input type="radio" name="spDefaultFolderPreset" value="Non-Production\\Inbox" onchange="onSharePointDefaultFolderPresetChanged()" />
                                <span>Non-Production\Inbox</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
                                <input type="radio" name="spDefaultFolderPreset" value="Production\\Inbox" onchange="onSharePointDefaultFolderPresetChanged()" />
                                <span>Production\Inbox</span>
                            </label>
                        </div>
                        <div id="spFolderLockHint" style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
                            When auto-processing is ON, this folder is locked.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="spPollInterval"><i class="fas fa-clock"></i> Poll interval (seconds)</label>
                        <input type="number" id="spPollInterval" min="1" step="1" placeholder="60" />
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-toggle-on"></i> Auto-processing</label>
                        <div style="display:flex; gap:14px; flex-wrap:wrap; padding: 6px 2px;">
                            <label style="display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
                                <input type="radio" name="spActivate" id="spActivateOn" value="true" onchange="onSharePointActivateChanged()" />
                                <span>ON</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;">
                                <input type="radio" name="spActivate" id="spActivateOff" value="false" checked onchange="onSharePointActivateChanged()" />
                                <span>OFF</span>
                            </label>
                        </div>
                        <div id="spActivateStatus" style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
                            Disabled by default. When enabled, the server will scan the Default folder and process PDFs automatically.
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn" type="button" onclick="loadSharePointSettings()" style="flex:1; padding: 12px 14px;">
                            <span><i class="fas fa-rotate"></i> Reload settings</span>
                        </button>
                        <button class="btn" type="button" onclick="saveSharePointSettings()" style="flex:1; padding: 12px 14px;">
                            <span><i class="fas fa-floppy-disk"></i> Save settings</span>
                        </button>
                        <button class="btn" type="button" onclick="validateSharePointSettings()" style="flex:1; padding: 12px 14px;">
                            <span><i class="fas fa-circle-check"></i> Validate</span>
                        </button>
                    </div>
                    <div id="spValidateStatusBox" style="display:none; margin-top:10px; padding:10px 12px; border-radius:12px; font-size:13px;"></div>
                </div>
            </details>

            <div class="form-group">
                <label for="sharepointUrl"><i class="fas fa-file"></i> File to process (URL or server-relative path)</label>
                <input type="text" id="sharepointUrl" placeholder="e.g.: /sites/APOCR/Shared Documents/Invoices/file.pdf (or full file URL)" />
            </div>
            <div class="form-group">
                <label for="sharepointFolder"><i class="fas fa-folder-open"></i> Folder path (optional)</label>
                <input type="text" id="sharepointFolder" placeholder="e.g.: /Shared Documents" />
            </div>

            <details class="upload-details" style="margin-top: 10px;">
                <summary><i class="fas fa-folder-tree"></i> Browse SharePoint folder</summary>
                <div class="upload-details-body">
                    <div title="Current folder" style="margin-bottom: 10px;">
                        <div id="spBrowseBreadcrumbs" style="font-size: 12px; opacity: .95; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
                        <div style="font-size: 11px; opacity: .75; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 2px;">
                            <span style="opacity:.9;">Path:</span>
                            <span id="spBrowsePath" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn" type="button" onclick="browseSharePointUp()" style="padding: 10px 12px; min-width: 92px; flex:1;">
                            <span><i class="fas fa-arrow-up"></i> Up</span>
                        </button>
                        <button class="btn" type="button" onclick="openSharePointUploadPicker()" style="padding: 10px 12px; min-width: 120px; flex:1;">
                            <span><i class="fas fa-upload"></i> Upload</span>
                        </button>
                        <button class="btn" type="button" onclick="browseSharePoint()" style="padding: 10px 12px; min-width: 110px; flex:1;">
                            <span><i class="fas fa-rotate"></i> Refresh</span>
                        </button>
                    </div>
                    <!-- Multi-selection controls -->
                    <div id="spMultiSelectBar" style="display:none; margin-top:10px; padding:10px 12px; border-radius:10px; background:linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05)); border:1px solid rgba(239,68,68,0.2);">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:13px;">
                                <input type="checkbox" id="spSelectAll" onchange="toggleSelectAllSharePoint(this.checked)" style="width:16px; height:16px; cursor:pointer;" />
                                <span>Select All</span>
                            </label>
                            <span id="spSelectedCount" style="font-size:13px; opacity:0.8;">0 selected</span>
                            <button class="btn" type="button" onclick="deleteSelectedSharePointItems()" style="padding:8px 14px; background:linear-gradient(135deg, #ef4444, #dc2626); margin-left:auto;">
                                <span><i class="fas fa-trash"></i> Delete Selected</span>
                            </button>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center; margin-top: 10px; flex-wrap: wrap;">
                        <input type="file" id="spUploadFiles" multiple style="position:absolute; left:-10000px; width:1px; height:1px; opacity:0;" onchange="onSharePointUploadFilesSelected(event)" />
                        <input type="file" id="spUploadFolder" webkitdirectory directory multiple style="position:absolute; left:-10000px; width:1px; height:1px; opacity:0;" onchange="onSharePointUploadFolderSelected(event)" />

                        <div id="spUploadSummary" style="flex:1; min-width: 220px; font-size:12px; opacity:.85; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            Click Upload to select files or a folder
                        </div>
                    </div>
                    <div id="spBrowseList" style="margin-top: 10px;"></div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
                        Tip: click a PDF to auto-fill the “File to process” field.
                    </div>
                </div>
            </details>

            <details class="upload-details" style="margin-top: 10px;">
                <summary><i class="fas fa-sitemap"></i> Folder structure (tree)</summary>
                <div class="upload-details-body">
                    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div class="form-group" style="flex:2; min-width: 260px; margin:0;">
                            <label for="spTreePath"><i class="fas fa-folder"></i> Path</label>
                            <input type="text" id="spTreePath" placeholder="Defaults to current browse path" />
                        </div>
                        <div class="form-group" style="width:120px; margin:0;">
                            <label for="spTreeDepth"><i class="fas fa-layer-group"></i> Depth</label>
                            <input type="number" id="spTreeDepth" min="0" max="25" step="1" value="4" />
                        </div>
                        <div class="form-group" style="width:150px; margin:0;">
                            <label for="spTreeMaxNodes"><i class="fas fa-gauge"></i> Max nodes</label>
                            <input type="number" id="spTreeMaxNodes" min="50" max="20000" step="50" value="1500" />
                        </div>
                        <div class="form-group" style="display:flex; align-items:center; gap:8px; margin:0; padding-bottom: 6px;">
                            <input type="checkbox" id="spTreeIncludeFiles" />
                            <label for="spTreeIncludeFiles" style="margin:0;"><i class="fas fa-file"></i> Include files</label>
                        </div>
                        <button class="btn" type="button" onclick="loadSharePointTree()" style="padding: 10px 12px; min-width: 140px;">
                            <span><i class="fas fa-diagram-project"></i> Load tree</span>
                        </button>
                        <button class="btn" type="button" onclick="useBrowsePathForTree()" style="padding: 10px 12px; min-width: 140px;" title="Copy the current SharePoint browse path into the Path field">
                            <span><i class="fas fa-location-crosshairs"></i> Use current (browse)</span>
                        </button>
                    </div>
                    <div id="spTreeStatus" style="margin-top:10px; display:none; padding:10px 12px; border-radius:12px; font-size:13px;"></div>
                    <div id="spTreeOutput" class="sp-tree" style="margin-top:10px;"></div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
                        Tip: depth 3–5 is usually enough. Increase max nodes only if needed.
                    </div>
                </div>
            </details>

            <button class="btn" onclick="processSharePoint()">
                <span><i class="fas fa-cloud-download-alt"></i> Process SharePoint PDF</span>
            </button>
        </div>

        <!-- Windows folder tab -->
        <div id="folder-tab" class="tab-content">
            <div class="form-group">
                <label for="folderPath"><i class="fas fa-folder"></i> Windows folder path (output directory)</label>
                <input type="text" id="folderPath" placeholder="e.g.: \\server\share\outputs" />
            </div>
            <button class="btn" onclick="saveNetworkShareDir()">
                <span><i class="fas fa-save"></i> Save Windows folder (output)</span>
            </button>
        </div>

        <!-- Progress bar -->
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">
                <span id="progressLabel">Ready</span>
                <span class="progress-percent" id="progressPercent">0%</span>
            </div>
        </div>

        <!-- Results -->
        <div class="result" id="result"></div>
    </div>

    <footer class="footer">
        <div class="footer-text">
            OpenMiner™ &copy; 2026 • Built with <i class="fas fa-heart" style="color:#ef4444;"></i> an Open Mind<br>
        </div>
    </footer>

    <script>
        let selectedFiles = [];
        let ws = null;
        let currentTaskId = null;
        let currentProgress = 0;
        let targetProgress = 0;
        let isAnimating = false;

        function getFileDisplayPath(file) {
            // folder drag-drop: we attach a best-effort relative path to File objects
            // (File is extensible in JS; browsers keep it as an object)
            return (file && (file._relativePath || file.webkitRelativePath || file.name)) ? (file._relativePath || file.webkitRelativePath || file.name) : '';
        }

        function isSupportedUploadFile(file) {
            const name = getFileDisplayPath(file).toLowerCase();
            return name.endsWith('.pdf') || name.endsWith('.json');
        }

        function openFilePicker() {
            const input = document.getElementById('fileInput');
            if (!input) return;
            input.click();
        }

        function openFolderPicker() {
            const input = document.getElementById('folderInput');
            if (!input) return;

            // Best-effort feature hint. If unsupported, clicking may do nothing.
            const supportsDirectory = input.hasAttribute('webkitdirectory') || input.hasAttribute('directory');
            if (!supportsDirectory) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Your browser may not support folder upload. Please use Chrome / Edge.');
                return;
            }

            input.click();
        }

        function getUploadFileMeta(file) {
            const fileName = getFileDisplayPath(file);
            const lower = fileName.toLowerCase();
            const ext = lower.split('.').pop();
            const isJSON = ext === 'json';
            const parts = fileName.split('/').filter(Boolean);
            const displayName = parts.length ? parts[parts.length - 1] : fileName;
            const displayPath = parts.length > 1 ? parts.slice(0, -1).join('/') + '/' : '';
            return {
                fileName,
                displayName,
                displayPath,
                ext,
                fileType: isJSON ? 'JSON' : 'PDF',
                fileTypeIcon: isJSON ? 'fa-file-code' : 'fa-file-pdf',
                fileTypeColor: isJSON ? '#10b981' : '#667eea',
                fileTypeInfo: isJSON
                    ? '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> JSON file (MinerU OCR will be skipped)</span>'
                    : '<span style="color: #667eea;"><i class="fas fa-check-circle"></i> PDF file (OCR will run)</span>',
            };
        }

        function updateUploadButtonState() {
            const uploadBtn = document.getElementById('uploadBtn');
            if (!uploadBtn) return;
            const n = selectedFiles.length;
            uploadBtn.disabled = n === 0;
            uploadBtn.querySelector('span').innerHTML = n <= 1
                ? '<i class="fas fa-magic"></i> Process'
                : `<i class="fas fa-layer-group"></i> Batch process (${n} files)`;
        }

        function renderSelectedFilesInfo() {
            const fileInfo = document.getElementById('fileInfo');
            if (!fileInfo) return;

            if (!selectedFiles.length) {
                fileInfo.style.display = 'none';
                fileInfo.innerHTML = '';
                return;
            }

            fileInfo.style.display = 'block';

            if (selectedFiles.length === 1) {
                const f = selectedFiles[0];
                const meta = getUploadFileMeta(f);
                fileInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas ${meta.fileTypeIcon}" style="font-size: 1.5em; color: ${meta.fileTypeColor};"></i>
                        <div>
                            <strong>Selected:</strong> ${meta.displayName}<br>
                            ${meta.displayPath ? `<strong>Source path:</strong> ${meta.displayPath}<br>` : ''}
                            <strong>Type:</strong> ${meta.fileType}<br>
                            <strong>Size:</strong> ${(f.size / 1024 / 1024).toFixed(2)} MB
                        </div>
                    </div>
                    ${meta.fileTypeInfo}
                `;
                return;
            }

            const totalMB = selectedFiles.reduce((sum, f) => sum + (f.size || 0), 0) / 1024 / 1024;
            const listHtml = selectedFiles.slice(0, 12).map((f, idx) => {
                const meta = getUploadFileMeta(f);
                return `
                    <div style="display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.55); margin-top:8px;">
                        <div style="width:24px; text-align:center; color:#64748b; font-weight:700;">${idx + 1}</div>
                        <i class="fas ${meta.fileTypeIcon}" style="color:${meta.fileTypeColor};"></i>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:600; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${meta.displayName}</div>
                            <div style="font-size:12px; color:#64748b; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${meta.displayPath || ''}${meta.fileType}｜${(f.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                `;
            }).join('');

            const more = selectedFiles.length > 12 ? `<div style="margin-top:10px; color:#64748b; font-size:12px;">(+ ${selectedFiles.length - 12} more not shown)</div>` : '';

            fileInfo.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <i class="fas fa-layer-group" style="font-size: 1.5em; color: #667eea;"></i>
                    <div>
                        <strong>Selected:</strong> ${selectedFiles.length} files<br>
                        <strong>Total size:</strong> ${totalMB.toFixed(2)} MB<br>
                        <span style="color:#64748b; font-size:12px;">(Uploaded and processed sequentially)</span>
                    </div>
                </div>
                ${listHtml}
                ${more}
            `;
        }

        function setSelectedFiles(files) {
            const filtered = Array.from(files || []).filter(isSupportedUploadFile);
            selectedFiles = filtered;
            renderSelectedFilesInfo();
            updateUploadButtonState();
        }

        function resetProgressBar() {
            currentProgress = 0;
            targetProgress = 0;
            isAnimating = false;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) progressFill.style.width = '0%';
            const progressPercent = document.getElementById('progressPercent');
            if (progressPercent) progressPercent.textContent = '0%';
        }

        async function refreshRuntimeSubtitle() {
            const el = document.getElementById('runtimeSubtitle');
            if (!el) return;

            try {
                const resp = await fetch('/api/runtime_status', { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();

                const mineru = data?.mineru || {};
                const csv = data?.csv || {};
                const ai = data?.ai || {};

                const mineruEngine = mineru.effective_engine === 'vllm-async-engine' ? 'vLLM' : 'CLI';
                const mineruParts = [
                    `MinerU: ${mineruEngine}`,
                    mineru.mineru_method ? `mode=${mineru.mineru_method}` : null,
                    mineru.output_source ? `output=${mineru.output_source}` : null,
                ].filter(Boolean).join(' (') + (mineru.mineru_method || mineru.output_source ? ')' : '');

                let csvLabel = 'CSV: ';
                if (csv.effective_method === 'program_csv') csvLabel += 'Program CSV';
                else if (csv.effective_method === 'mineru_csv') csvLabel += 'MinerU direct';
                else csvLabel += 'AI generated';

                let aiLabel = '';
                if (csv.effective_method === 'azure_openai_csv') {
                    const model = ai.azure_deployment ? `, model=${ai.azure_deployment}` : '';
                    const t = (ai.temperature !== undefined && ai.temperature !== null) ? `, T=${ai.temperature}` : '';
                    aiLabel = ` | AI: Azure OpenAI${model}${t}`;
                } else if (ai.service === 'ollama') {
                    const model = ai.ollama_model ? `, model=${ai.ollama_model}` : '';
                    const t = (ai.temperature !== undefined && ai.temperature !== null) ? `, T=${ai.temperature}` : '';
                    aiLabel = ` | AI: Ollama${model}${t}`;
                } else if (csv.effective_method === 'mineru_csv' || csv.effective_method === 'program_csv') {
                    aiLabel = '';
                }

                const notes = [];
                if (mineru.forced_cli) notes.push('vLLM disabled (JSON output requires CLI)');
                else if (mineru.use_vllm_async && !mineru.vllm_available) notes.push('vLLM unavailable; falling back to CLI');
                if (csv.fallback) notes.push('AI not initialized; falling back to MinerU direct');

                const noteText = notes.length ? ` (${notes.join('; ')})` : '';
                el.textContent = `${mineruParts} | ${csvLabel}${aiLabel}${noteText}`;
            } catch (e) {
                // Fallback copy (avoid blank)
                el.textContent = 'Smart PDF processing with MinerU and AI';
            }
        }

        async function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.closest('.tab').classList.add('active');

            if (tabName === 'sharepoint') {
                // Best-effort: load settings when opening the SharePoint tab.
                loadSharePointSettings().catch(() => {});
            }
            if (tabName === 'folder') {
                // Best-effort: load saved Windows network folder when opening the Folder tab.
                try {
                    const resp = await fetch('/api/settings/network_share', { method: 'GET' });
                    const d = await resp.json();
                    if (resp.ok && d && d.path) {
                        const el = document.getElementById('folderPath');
                        if (el && !el.value) el.value = d.path;
                    }
                } catch (_) {}
            }
        }

        // File selection handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            setSelectedFiles(e.target.files);
            if (!selectedFiles.length && (e.target.files || []).length) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Unsupported file type. Please upload PDF or JSON.');
            }
        });

        // Folder selection handling (Chrome/Edge support webkitdirectory)
        document.getElementById('folderInput').addEventListener('change', function(e) {
            setSelectedFiles(e.target.files);
            if (!selectedFiles.length && (e.target.files || []).length) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> No PDF/JSON found in this folder.');
            }
        });

        // Update subtitle on load (reflect backend runtime status)
        document.addEventListener('DOMContentLoaded', () => {
            refreshRuntimeSubtitle();
            // Best-effort: prefill prompt boxes from saved defaults only when empty.
            loadPromptDefaults(true).catch(() => {});
        });

        function showPromptStatus(kind, message) {
            const box = document.getElementById('promptStatusBox');
            if (!box) return;
            box.style.display = 'block';
            const colors = {
                success: { bg: 'rgba(16,185,129,.12)', fg: '#065f46', border: '1px solid rgba(16,185,129,.25)' },
                error: { bg: 'rgba(239,68,68,.12)', fg: '#7f1d1d', border: '1px solid rgba(239,68,68,.25)' },
                info: { bg: 'rgba(99,102,241,.12)', fg: '#312e81', border: '1px solid rgba(99,102,241,.25)' },
            };
            const c = colors[kind] || colors.info;
            box.style.background = c.bg;
            box.style.color = c.fg;
            box.style.border = c.border;
            box.innerHTML = message;
        }

        async function loadPromptDefaults(fillIfEmptyOnly) {
            const sysEl = document.getElementById('systemPromptInput');
            const userEl = document.getElementById('userPromptInput');
            if (!sysEl || !userEl) return;

            if (fillIfEmptyOnly) {
                const hasAny = (sysEl.value && sysEl.value.trim().length) || (userEl.value && userEl.value.trim().length);
                if (hasAny) return;
            }

            showPromptStatus('info', '<i class="fas fa-spinner fa-spin"></i> Loading prompt defaults…');
            const resp = await fetch('/api/settings/prompts');
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                throw new Error(data.detail || 'Failed to load prompt defaults');
            }
            sysEl.value = (data.system_prompt || '').toString();
            userEl.value = (data.user_prompt || '').toString();
            showPromptStatus('success', '<i class="fas fa-check-circle"></i> Loaded prompt defaults from .env');
        }

        async function savePromptDefaults() {
            const sysEl = document.getElementById('systemPromptInput');
            const userEl = document.getElementById('userPromptInput');
            if (!sysEl || !userEl) return;

            const payload = {
                system_prompt: (sysEl.value || '').toString(),
                user_prompt: (userEl.value || '').toString(),
            };

            showPromptStatus('info', '<i class="fas fa-spinner fa-spin"></i> Saving prompt defaults…');
            const resp = await fetch('/api/settings/prompts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) {
                showPromptStatus('error', '<i class="fas fa-times-circle"></i> ' + (data.detail || 'Failed to save prompts'));
                return;
            }
            showPromptStatus('success', '<i class="fas fa-check-circle"></i> Saved prompt defaults to .env (takes effect immediately)');
        }

        // Drag & drop handling
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        async function readEntriesAsync(reader) {
            return new Promise((resolve) => {
                reader.readEntries((entries) => resolve(entries || []));
            });
        }

        async function traverseEntry(entry, pathPrefix) {
            if (!entry) return [];

            if (entry.isFile) {
                return new Promise((resolve) => {
                    entry.file(
                        (file) => {
                            try {
                                file._relativePath = (pathPrefix || '') + file.name;
                            } catch (_) {
                                // ignore; still usable via file.name
                            }
                            resolve([file]);
                        },
                        () => resolve([])
                    );
                });
            }

            if (entry.isDirectory) {
                const reader = entry.createReader();
                const dirPrefix = (pathPrefix || '') + entry.name + '/';
                let all = [];
                while (true) {
                    const batch = await readEntriesAsync(reader);
                    if (!batch.length) break;
                    for (const child of batch) {
                        const childFiles = await traverseEntry(child, dirPrefix);
                        all = all.concat(childFiles);
                    }
                }
                return all;
            }

            return [];
        }

        async function collectDroppedFiles(dataTransfer) {
            // Some browsers include only a folder "placeholder" in dataTransfer.files.
            // Use webkitGetAsEntry() to recursively collect files.
            const items = dataTransfer?.items ? Array.from(dataTransfer.items) : [];
            const entries = [];
            for (const item of items) {
                const entry = item?.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                if (entry) entries.push(entry);
            }

            if (!entries.length) {
                return Array.from(dataTransfer?.files || []);
            }

            let all = [];
            for (const entry of entries) {
                const prefix = '';
                const files = await traverseEntry(entry, prefix);
                all = all.concat(files);
            }

            // De-dupe by (relativePath/name, size, lastModified)
            const seen = new Set();
            const deduped = [];
            for (const f of all) {
                const key = `${getFileDisplayPath(f)}|${f.size}|${f.lastModified}`;
                if (seen.has(key)) continue;
                seen.add(key);
                deduped.push(f);
            }
            return deduped;
        }

        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const dt = e.dataTransfer;
            const files = await collectDroppedFiles(dt);
            if (!files.length) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Could not read dropped items. Try the “Choose folder” button instead.');
                return;
            }

            const supported = files.filter(isSupportedUploadFile);
            if (!supported.length) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Unsupported file type. Please upload PDF or JSON.');
                return;
            }

            // Sync into the hidden file input (best-effort; used only for consistency)
            try {
                const dataTransfer = new DataTransfer();
                supported.forEach(f => dataTransfer.items.add(f));
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.files = dataTransfer.files;
                setSelectedFiles(dataTransfer.files);
            } catch (err) {
                // If browser blocks programmatic assignment, still proceed with our internal list.
                setSelectedFiles(supported);
            }
        });

        function renderBatchResult(batchItems, headline) {
            const okCount = batchItems.filter(x => x.status === 'success').length;
            const failCount = batchItems.filter(x => x.status === 'error').length;
            const total = batchItems.length;

            let content = `<div class="result-title">${headline || `<i class=\"fas fa-layer-group\"></i> Batch: ${okCount}/${total} succeeded, ${failCount} failed`}</div>`;
            content += `<div class="result-content" style="margin-top:10px;">`;
            batchItems.forEach((item, idx) => {
                const badgeColor = item.status === 'success' ? '#10b981' : (item.status === 'error' ? '#ef4444' : (item.status === 'processing' ? '#667eea' : '#94a3b8'));
                const badgeText = item.status === 'success' ? 'Done' : (item.status === 'error' ? 'Failed' : (item.status === 'processing' ? 'Processing' : 'Pending'));
                content += `
                    <div style="margin-top: 10px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 10px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:24px; text-align:center; color:#64748b; font-weight:700;">${idx + 1}</div>
                            <i class="fas ${item.icon}" style="color:${item.color};"></i>
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:600; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.displayName || item.name}</div>
                                <div style="font-size:12px; color:#64748b; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.displayPath || ''}${item.kind}｜${item.sizeMB} MB</div>
                            </div>
                            <div style="font-size:12px; font-weight:700; color:${badgeColor};">${badgeText}</div>
                        </div>
                        ${item.download_url ? `
                            <div style=\"margin-top: 10px;\">
                                <a href=\"${item.download_url}\" class=\"download-link\">
                                    <i class=\"fas fa-download\"></i> Download JSON
                                </a>
                            </div>
                        ` : ''}
                        ${item.error ? `<div style="margin-top:8px; color:#b91c1c; font-size:12px;">${item.error}</div>` : ''}
                    </div>
                `;
            });
            content += `</div>`;

            showResult('success', content);
        }

        async function uploadSingleFile(file, systemPrompt, userPrompt, batchPrefix) {
            const formData = new FormData();
            formData.append('file', file);
            if (systemPrompt && systemPrompt.trim().length > 0) formData.append('system_prompt', systemPrompt);
            if (userPrompt && userPrompt.trim().length > 0) formData.append('user_prompt', userPrompt);

            currentTaskId = generateTaskId();
            formData.append('task_id', currentTaskId);

            try {
                resetProgressBar();
                updateProgress(0, `${batchPrefix || ''}Connecting…`);
                try {
                    await connectWebSocket(currentTaskId);
                } catch (wsError) {
                    console.warn('[Upload] WebSocket connection failed; continuing upload:', wsError);
                }

                updateProgress(5, `${batchPrefix || ''}Uploading…`);
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                let data = null;
                try {
                    data = await response.json();
                } catch {
                    data = null;
                }

                if (ws) {
                    ws.close();
                    ws = null;
                }

                return { ok: response.ok, status: response.status, data };
            } catch (error) {
                if (ws) {
                    ws.close();
                    ws = null;
                }
                return { ok: false, status: 0, data: { detail: error?.message || String(error) } };
            }
        }

        async function uploadFile() {
            if (!selectedFiles || selectedFiles.length === 0) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Please choose files first.');
                return;
            }

            // The UI no longer offers CSV options; the API returns JSON only.
            const systemPrompt = document.getElementById('systemPromptInput').value;
            const userPrompt = document.getElementById('userPromptInput').value;

            // Hide button and show progress bar
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.style.display = 'none';
            uploadBtn.disabled = true;
            showProgress(true);
            hideResult();

            try {
                if (selectedFiles.length === 1) {
                    const file = selectedFiles[0];
                    const result = await uploadSingleFile(file, systemPrompt, userPrompt, '');

                    if (result.ok) {
                        const data = result.data || {};
                        let message = '<i class="fas fa-check-circle"></i> Completed successfully!';
                        if (data.file_type === 'json') {
                            message += ' (JSON file skipped MinerU OCR)';
                        } else if (data.needs_ocr) {
                            message += ' (OCR completed)';
                        } else {
                            message += ' (Text extracted directly; no OCR needed)';
                        }
                        showResult('success', message, data);
                    } else {
                        const data = result.data || {};
                        showResult('error', '<i class="fas fa-times-circle"></i> ' + (data.detail || 'Processing failed'));
                    }
                    return;
                }

                // Batch mode
                const batchItems = selectedFiles.map(f => {
                    const meta = getUploadFileMeta(f);
                    return {
                        file: f,
                        name: meta.fileName,
                        displayName: meta.displayName,
                        displayPath: meta.displayPath,
                        kind: meta.fileType,
                        icon: meta.fileTypeIcon,
                        color: meta.fileTypeColor,
                        sizeMB: (f.size / 1024 / 1024).toFixed(2),
                        status: 'pending',
                        download_url: null,
                        error: null,
                    };
                });

                renderBatchResult(batchItems, '<i class="fas fa-layer-group"></i> Batch processing started');

                for (let i = 0; i < batchItems.length; i++) {
                    const item = batchItems[i];
                    item.status = 'processing';
                    renderBatchResult(batchItems, `<i class=\"fas fa-layer-group\"></i> Batch (${i + 1}/${batchItems.length})`);

                    const prefix = `(${i + 1}/${batchItems.length}) ${item.name} - `;
                    const result = await uploadSingleFile(item.file, systemPrompt, userPrompt, prefix);

                    if (result.ok) {
                        item.status = 'success';
                        item.download_url = result.data?.download_url || null;
                    } else {
                        item.status = 'error';
                        item.error = (result.data && result.data.detail) ? result.data.detail : 'Processing failed';
                    }

                    renderBatchResult(batchItems);
                }
            } catch (error) {
                showResult('error', '<i class="fas fa-times-circle"></i> Upload failed: ' + error.message);
            } finally {
                setTimeout(() => {
                    showProgress(false);
                    uploadBtn.style.display = 'block';
                    uploadBtn.disabled = selectedFiles.length === 0;
                    updateUploadButtonState();
                }, 1000);
            }
        }

        async function processSharePoint() {
            const fileUrl = document.getElementById('sharepointUrl').value;
            const folderPath = document.getElementById('sharepointFolder').value;

            if (!fileUrl) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Please enter a SharePoint file URL or path.');
                return;
            }

            const formData = new FormData();
            formData.append('file_url', fileUrl);
            if (folderPath) {
                formData.append('folder_path', folderPath);
            }

            showProgress(true);
            hideResult();

            try {
                const response = await fetch('/api/process-sharepoint', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('success', '<i class="fas fa-check-circle"></i> SharePoint PDF processed successfully!', data);
                } else {
                    showResult('error', '<i class="fas fa-times-circle"></i> ' + (data.detail || 'Processing failed'));
                }
            } catch (error) {
                showResult('error', '<i class="fas fa-times-circle"></i> Processing failed: ' + error.message);
            } finally {
                showProgress(false);
            }
        }

        function setSecretStatusText(isSet) {
            const el = document.getElementById('spSecretStatus');
            if (!el) return;
            el.textContent = isSet ? '(set)' : '(not set)';
        }

        async function loadSharePointSettings() {
            try {
                const response = await fetch('/api/settings/sharepoint', { method: 'GET' });
                const data = await response.json();
                if (!response.ok) {
                    showResult('error', '<i class="fas fa-times-circle"></i> Failed to load SharePoint settings: ' + (data.detail || 'Unknown error'));
                    return;
                }

                document.getElementById('spClientId').value = data.client_id || '';
                document.getElementById('spTenant').value = data.tenant || '';
                document.getElementById('spLink').value = data.link || '';
                const savedFolder = String(data.folder || '').trim();
                document.getElementById('spDefaultFolder').value = savedFolder;
                syncSharePointDefaultFolderPreset(savedFolder);
                document.getElementById('spPollInterval').value = (data.poll_interval !== null && data.poll_interval !== undefined) ? data.poll_interval : '';

                // Activation mode
                setSharePointActivateUi(Boolean(data.sp_activate));

                // Secret is intentionally not returned. Keep input blank.
                document.getElementById('spSecret').value = '';
                setSecretStatusText(Boolean(data.secret_set));

                // Convenience: default the processing folder field from settings if empty.
                const procFolder = document.getElementById('sharepointFolder');
                if (procFolder && !procFolder.value && data.folder) {
                    procFolder.value = data.folder;
                }

                // Preload folder browser with default folder.
                const startFolder = (data.folder || '').trim() || (procFolder ? (procFolder.value || '').trim() : '') || '/';
                await browseSharePoint(startFolder);
                // Load saved network share path into Windows folder input
                try {
                    const resp = await fetch('/api/settings/network_share', { method: 'GET' });
                    const d = await resp.json();
                    if (resp.ok && d && d.path) {
                        const el = document.getElementById('folderPath');
                        if (el && !el.value) el.value = d.path;
                    }
                } catch (_) {}
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Failed to load SharePoint settings: ' + e.message);
            }
        }

        async function saveSharePointSettings() {
            const payload = {
                client_id: document.getElementById('spClientId').value || '',
                tenant: document.getElementById('spTenant').value || '',
                secret: document.getElementById('spSecret').value || '',
                link: document.getElementById('spLink').value || '',
                folder: document.getElementById('spDefaultFolder').value || '',
                poll_interval: document.getElementById('spPollInterval').value || ''
            };

            try {
                const response = await fetch('/api/settings/sharepoint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) {
                    showResult('error', '<i class="fas fa-times-circle"></i> Failed to save SharePoint settings: ' + (data.detail || 'Unknown error'));
                    return;
                }
                // Secret is write-only; clear it after save.
                document.getElementById('spSecret').value = '';
                setSecretStatusText(Boolean(data.secret_set));
                showResult('success', '<i class="fas fa-check-circle"></i> SharePoint settings saved.');
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Failed to save SharePoint settings: ' + e.message);
            }
        }

        async function saveSharePointSettingsSilently() {
            const payload = {
                client_id: document.getElementById('spClientId').value || '',
                tenant: document.getElementById('spTenant').value || '',
                secret: document.getElementById('spSecret').value || '',
                link: document.getElementById('spLink').value || '',
                folder: document.getElementById('spDefaultFolder').value || '',
                poll_interval: document.getElementById('spPollInterval').value || ''
            };

            const response = await fetch('/api/settings/sharepoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Unknown error');
            }
            // Secret is write-only; clear it after save.
            document.getElementById('spSecret').value = '';
            setSecretStatusText(Boolean(data.secret_set));
        }

        function getSharePointActivateUi() {
            const el = document.querySelector('input[name="spActivate"]:checked');
            if (!el) return false;
            return String(el.value || '').toLowerCase() === 'true';
        }

        function setSharePointActivateUi(enabled) {
            const isOn = Boolean(enabled);
            const target = isOn ? 'spActivateOn' : 'spActivateOff';
            const el = document.getElementById(target);
            if (el) el.checked = true;

            const box = document.getElementById('spActivateStatus');
            if (box) {
                if (isOn) box.textContent = 'Activated: ON (auto-processes the Default folder)';
                else box.textContent = 'Deactivated: OFF (no automatic processing)';
            }

            updateSharePointFolderLock(isOn);
            updateSharePointSettingsLock(isOn);
        }

        function updateSharePointFolderLock(enabled) {
            const input = document.getElementById('spDefaultFolder');
            const hint = document.getElementById('spFolderLockHint');
            if (input) input.disabled = Boolean(enabled);
            if (hint) hint.style.opacity = enabled ? '1' : '0.6';
        }

        function updateSharePointSettingsLock(enabled) {
            const ids = [
                'spClientId',
                'spTenant',
                'spSecret',
                'spLink',
                'spDefaultFolder',
                'spPollInterval'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = Boolean(enabled);
            });

            const presets = document.querySelectorAll('input[name="spDefaultFolderPreset"]');
            presets.forEach(el => {
                el.disabled = Boolean(enabled);
            });
        }

        async function onSharePointActivateChanged() {
            const mode = getSharePointActivateUi();
            try {
                if (mode === true) {
                    await saveSharePointSettingsSilently();
                }
                const response = await fetch('/api/settings/sharepoint/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const data = await response.json();
                if (!response.ok) {
                    showResult('error', '<i class="fas fa-times-circle"></i> Failed to update activation: ' + (data.detail || 'Unknown error'));
                    return;
                }
                setSharePointActivateUi(Boolean(data.mode));
                showResult('success', '<i class="fas fa-check-circle"></i> SharePoint activation updated: ' + (data.mode ? 'ON' : 'OFF'));
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Failed to update activation: ' + e.message);
            }
        }

        function onSharePointDefaultFolderPresetChanged() {
            const el = document.querySelector('input[name="spDefaultFolderPreset"]:checked');
            if (!el) return;
            const value = String(el.value || '').trim();
            const input = document.getElementById('spDefaultFolder');
            if (input) input.value = value;
        }

        function syncSharePointDefaultFolderPreset(value) {
            const v = String(value || '').trim();
            const radios = document.querySelectorAll('input[name="spDefaultFolderPreset"]');
            let matched = false;
            radios.forEach(r => {
                if (String(r.value || '') === v) {
                    r.checked = true;
                    matched = true;
                }
            });
            if (!matched && radios.length) {
                radios[0].checked = true;
                const input = document.getElementById('spDefaultFolder');
                if (input) input.value = String(radios[0].value || '');
            }
        }

        function setSharePointValidateBox(kind, html) {
            const box = document.getElementById('spValidateStatusBox');
            if (!box) return;
            box.style.display = 'block';
            const isError = kind === 'error';
            box.style.background = isError ? 'rgba(239, 68, 68, 0.10)' : 'rgba(34, 197, 94, 0.10)';
            box.style.border = isError ? '1px solid rgba(239, 68, 68, 0.35)' : '1px solid rgba(34, 197, 94, 0.35)';
            box.style.color = isError ? '#991b1b' : '#166534';
            box.innerHTML = html;
        }

        async function validateSharePointSettings() {
            try {
                setSharePointValidateBox('success', '<i class="fas fa-spinner fa-spin"></i> Validating SharePoint connection…');
                const response = await fetch('/api/sharepoint/validate', { method: 'GET' });
                const data = await response.json();

                if (!response.ok || !data || data.ok !== true) {
                    const err = (data && data.error) ? data.error : {};
                    const msg = err.message || (data && data.detail) || 'Validation failed';
                    const aadsts = err.aadsts_code ? `<div style="margin-top:6px;"><b>${escapeHtml(err.aadsts_code)}</b></div>` : '';
                    const hint = err.hint ? `<div style="margin-top:6px; opacity:.9;">Hint: ${escapeHtml(err.hint)}</div>` : '';
                    const missing = (err.missing && err.missing.length)
                        ? `<div style="margin-top:6px; opacity:.9;">Missing: ${escapeHtml(err.missing.join(', '))}</div>`
                        : '';
                    const cfg = data && data.config ? data.config : null;
                    const cfgHtml = cfg
                        ? `<div style="margin-top:8px; opacity:.9; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
                               client_id: ${escapeHtml(String(cfg.client_id || ''))}<br/>
                               tenant: ${escapeHtml(String(cfg.tenant || ''))}<br/>
                               secret_length: ${escapeHtml(String(cfg.secret_length ?? ''))}<br/>
                               secret_has_whitespace: ${escapeHtml(String(cfg.secret_has_whitespace ?? ''))}<br/>
                               secret_looks_like_guid: ${escapeHtml(String(cfg.secret_looks_like_guid ?? ''))}
                           </div>`
                        : '';
                    setSharePointValidateBox('error', `<div><i class="fas fa-triangle-exclamation"></i> ${escapeHtml(msg)}</div>${aadsts}${hint}${missing}${cfgHtml}`);
                    return;
                }

                const webTitle = (data.web && data.web.title) ? data.web.title : '';
                const webUrl = (data.web && data.web.url) ? data.web.url : (data.site_url || '');
                const folderProbe = data.folder_probe;
                let folderHtml = '';
                if (folderProbe) {
                    if (folderProbe.exists) {
                        folderHtml = `<div style="margin-top:6px; opacity:.9;">Folder OK: ${escapeHtml(folderProbe.path || '')}</div>`;
                    } else {
                        folderHtml = `<div style="margin-top:6px; opacity:.9;">Folder check failed: ${escapeHtml(folderProbe.path || '')}</div>`;
                    }
                }

                setSharePointValidateBox(
                    'success',
                    `<div><i class="fas fa-check-circle"></i> Connected to SharePoint successfully.</div>` +
                    (webTitle ? `<div style="margin-top:6px; opacity:.9;">Site: <b>${escapeHtml(webTitle)}</b></div>` : '') +
                    (webUrl ? `<div style="margin-top:6px; opacity:.9;">URL: ${escapeHtml(webUrl)}</div>` : '') +
                    folderHtml
                );
            } catch (e) {
                setSharePointValidateBox('error', `<div><i class="fas fa-triangle-exclamation"></i> Validation failed: ${escapeHtml(e.message || String(e))}</div>`);
            }
        }

        let spBrowseCurrent = '/';

        function buildSharePointBreadcrumbsFromPath(path) {
            const p = String(path || '/');
            const parts = p.split('/').filter(Boolean);
            const crumbs = [{ name: '/', path: '/' }];
            let acc = '';
            parts.forEach(part => {
                acc += '/' + part;
                crumbs.push({ name: part, path: acc });
            });
            return crumbs;
        }

        function renderSharePointBreadcrumbs(breadcrumbs, fallbackPath) {
            const el = document.getElementById('spBrowseBreadcrumbs');
            if (!el) return;

            const crumbs = (Array.isArray(breadcrumbs) && breadcrumbs.length)
                ? breadcrumbs
                : buildSharePointBreadcrumbsFromPath(fallbackPath || spBrowseCurrent || '/');

            const html = crumbs.map((c, idx) => {
                const name = (c && c.name) ? String(c.name) : '';
                const path = (c && c.path) ? String(c.path) : '/';
                const sep = (idx === 0) ? '' : ' <span style="opacity:.55;">›</span> ';
                const label = (idx === 0) ? 'Home' : name;
                return sep + `<a href="#" onclick="browseSharePoint('${encodeURIComponent(path)}'); return false;" style="color:#2563eb; text-decoration:none; font-weight:700; padding:2px 4px; border-radius:6px;">${escapeHtml(label || '(root)')}</a>`;
            }).join('');

            el.style.whiteSpace = 'nowrap';
            el.style.overflowX = 'auto';
            el.style.paddingBottom = '2px';
            el.innerHTML = html || '';
        }

        function setBrowsePath(path) {
            spBrowseCurrent = path || '/';
            const el = document.getElementById('spBrowsePath');
            if (el) el.textContent = spBrowseCurrent;
            renderSharePointBreadcrumbs(null, spBrowseCurrent);
        }

        function setSharePointTreeStatus(kind, html) {
            const box = document.getElementById('spTreeStatus');
            if (!box) return;
            box.style.display = 'block';
            const isError = kind === 'error';
            box.style.background = isError ? 'rgba(239, 68, 68, 0.10)' : 'rgba(34, 197, 94, 0.10)';
            box.style.border = isError ? '1px solid rgba(239, 68, 68, 0.35)' : '1px solid rgba(34, 197, 94, 0.35)';
            box.style.color = isError ? '#991b1b' : '#166534';
            box.innerHTML = html;
        }

        function useBrowsePathForTree() {
            const input = document.getElementById('spTreePath');
            if (input) input.value = spBrowseCurrent || '/';
        }

        function selectSharePointTreeFolder(path) {
            const p = (path || '/').trim() || '/';
            const input = document.getElementById('spTreePath');
            if (input) input.value = p;

            // Also navigate the browse view to the selected folder for convenience.
            try {
                browseSharePoint(encodeURIComponent(p));
            } catch (_) {}

            setSharePointTreeStatus('success', `<div><i class="fas fa-folder-open"></i> Selected: <b>${escapeHtml(p)}</b></div>`);
        }

        function formatSharePointTree(tree) {
            // Native nested HTML tree view (<details>/<summary>) with clickable folders.
            function iconFolder() { return '📁'; }
            function iconFile(isPdf) { return isPdf ? '📄' : '🗎'; }

            function folderAnchor(label, path) {
                const p = (path || '/').trim() || '/';
                const js = JSON.stringify(p);
                // Stop propagation so clicking the link doesn't toggle <details>.
                return `<a class="sp-tree-folder" href="#" onclick="event.stopPropagation(); selectSharePointTreeFolder(${js}); return false;">${escapeHtml(label)}</a>`;
            }

            function renderNode(node, level) {
                const name = node && node.name ? String(node.name) : '';
                const path = node && node.path ? String(node.path) : '';
                const truncated = !!(node && node.truncated);
                const label = name || path || '(folder)';

                const folders = (node && node.folders) ? node.folders : [];
                const files = (node && node.files) ? node.files : [];

                const openAttr = (level <= 1) ? ' open' : '';
                const truncBadge = truncated ? ' <span style="opacity:.7; font-size:12px;">(truncated)</span>' : '';

                const childrenHtml = [];

                if (Array.isArray(files) && files.length) {
                    const fileRows = files.map(f => {
                        const fname = f && f.name ? String(f.name) : '';
                        const fpath = f && f.path ? String(f.path) : '';
                        const isPdf = !!(f && f.is_pdf);
                        const flabel = fname || fpath || '(file)';
                        return `<div class="sp-tree-file">${iconFile(isPdf)} ${escapeHtml(flabel)}</div>`;
                    }).join('');
                    childrenHtml.push(`<div class="sp-tree-files">${fileRows}</div>`);
                }

                if (Array.isArray(folders) && folders.length) {
                    childrenHtml.push(folders.map(child => renderNode(child, level + 1)).join(''));
                }

                return `
                    <details${openAttr}>
                        <summary>${iconFolder()} ${folderAnchor(label, path || '/')} ${truncBadge}</summary>
                        ${childrenHtml.join('')}
                    </details>
                `;
            }

            const root = tree && tree.root ? tree.root : null;
            if (!root) return '<div style="opacity:.8;">(No data)</div>';
            // Root without the extra left margin.
            return `
                <details open style="margin-left:0;">
                    <summary>${iconFolder()} ${folderAnchor(root.name || root.path || 'root', root.path || '/')}</summary>
                    ${(root.files && root.files.length) ? `<div class="sp-tree-files">${root.files.map(f => {
                        const fname = f && f.name ? String(f.name) : '';
                        const fpath = f && f.path ? String(f.path) : '';
                        const isPdf = !!(f && f.is_pdf);
                        const flabel = fname || fpath || '(file)';
                        return `<div class="sp-tree-file">${iconFile(isPdf)} ${escapeHtml(flabel)}</div>`;
                    }).join('')}</div>` : ''}
                    ${(root.folders && root.folders.length) ? root.folders.map(child => renderNode(child, 1)).join('') : ''}
                </details>
            `;
        }

        async function loadSharePointTree() {
            const outEl = document.getElementById('spTreeOutput');
            if (outEl) outEl.innerHTML = '';

            const pathInput = document.getElementById('spTreePath');
            const depthInput = document.getElementById('spTreeDepth');
            const maxNodesInput = document.getElementById('spTreeMaxNodes');
            const includeFilesInput = document.getElementById('spTreeIncludeFiles');

            const folderPath = (pathInput && pathInput.value ? pathInput.value : '').trim() || (spBrowseCurrent || '/');
            const depth = depthInput && depthInput.value ? depthInput.value : '4';
            const maxNodes = maxNodesInput && maxNodesInput.value ? maxNodesInput.value : '1500';
            const includeFiles = !!(includeFilesInput && includeFilesInput.checked);

            try {
                setSharePointTreeStatus('success', '<i class="fas fa-spinner fa-spin"></i> Loading tree…');
                const qs = new URLSearchParams({
                    folder_path: folderPath,
                    depth: String(depth),
                    max_nodes: String(maxNodes),
                    include_files: includeFiles ? 'true' : 'false'
                });
                const response = await fetch('/api/sharepoint/tree?' + qs.toString(), { method: 'GET' });
                const data = await response.json();
                if (!response.ok) {
                    const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : 'Failed to load tree';
                    setSharePointTreeStatus('error', `<div><i class="fas fa-triangle-exclamation"></i> ${escapeHtml(String(msg))}</div>`);
                    return;
                }

                const visited = (data && typeof data.visited === 'number') ? data.visited : null;
                const trunc = data && data.root && data.root.truncated;
                const extra = visited !== null ? `Visited: <b>${visited}</b>` : '';
                const extra2 = trunc ? ' • <b>Truncated</b>' : '';
                setSharePointTreeStatus('success', `<div><i class="fas fa-check-circle"></i> Tree loaded. ${extra}${extra2}</div>`);
                if (outEl) outEl.innerHTML = formatSharePointTree(data);
            } catch (e) {
                setSharePointTreeStatus('error', `<div><i class="fas fa-triangle-exclamation"></i> Failed to load tree: ${escapeHtml(e.message || String(e))}</div>`);
            }
        }

        function renderBrowseList(items) {
            const el = document.getElementById('spBrowseList');
            if (!el) return;

            const folders = (items && items.folders) ? items.folders : [];
            const files = (items && items.files) ? items.files : [];

            if (!folders.length && !files.length) {
                el.innerHTML = '<div style="opacity:.8; font-size: 13px;">(Empty)</div>';
                return;
            }

            const folderHtml = folders.map(f => {
                const name = f.name || f.server_relative_url || '';
                const url = f.server_relative_url || '';
                const created = f.created_date_time || '';
                const modified = f.last_modified_date_time || '';
                const metaParts = [];
                if (modified || created) metaParts.push(`<span title="${escapeHtml(modified || created)}">${escapeHtml(formatDateTime(modified || created))}</span>`);
                const meta = metaParts.length ? `<div style="font-size: 11px; opacity: .75; margin-top: 2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${metaParts.join(' • ')}</div>` : '';
                const payload = encodeURIComponent(JSON.stringify({
                    name: name,
                    path: url,
                    drive_id: f.drive_id || '',
                    item_id: f.item_id || ''
                }));

                return `
                    <div class="sp-browse-item" data-payload="${payload}" style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.55); margin-bottom:8px; cursor:pointer;" onclick="browseSharePoint('${encodeURIComponent(url)}')">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" class="sp-item-checkbox" data-payload="${payload}" onclick="event.stopPropagation(); updateSharePointSelection()" style="width:16px; height:16px; cursor:pointer;" />
                            <i class="fas fa-folder" style="color:#6366f1;"></i>
                            <div style="min-width:0;">
                                <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(name)}</div>
                                ${meta}
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="btn" type="button" onclick="deleteSharePointItem(event, '${payload}')" style="padding: 10px 12px; min-width: 46px;">
                                <span title="Delete"><i class="fas fa-trash"></i></span>
                            </button>
                            <i class="fas fa-chevron-right" style="opacity:.6;"></i>
                        </div>
                    </div>
                `;
            }).join('');

            const fileHtml = files.map(f => {
                const name = f.name || f.server_relative_url || '';
                const url = f.server_relative_url || '';
                const payload = encodeURIComponent(JSON.stringify({
                    name: name,
                    path: url,
                    drive_id: f.drive_id || '',
                    item_id: f.item_id || ''
                }));
                const isPdf = !!f.is_pdf;
                const icon = isPdf ? 'fa-file-pdf' : 'fa-file';
                const color = isPdf ? '#ef4444' : '#64748b';
                const size = (typeof f.size === 'number') ? f.size : null;
                const created = f.created_date_time || '';
                const modified = f.last_modified_date_time || '';
                const metaParts = [];
                if (created) metaParts.push(`<span title="Uploaded">Uploaded: ${escapeHtml(formatDateTime(created))}</span>`);
                else if (modified) metaParts.push(`<span title="Modified">Modified: ${escapeHtml(formatDateTime(modified))}</span>`);
                if (size !== null) metaParts.push(`<span title="Size">${escapeHtml(formatBytes(size))}</span>`);
                const meta = metaParts.length ? `<div style="font-size: 11px; opacity: .75; margin-top: 2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${metaParts.join(' • ')}</div>` : '';
                return `
                    <div class="sp-browse-item" data-payload="${payload}" style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.55); margin-bottom:8px;">
                        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                            <input type="checkbox" class="sp-item-checkbox" data-payload="${payload}" onclick="event.stopPropagation(); updateSharePointSelection()" style="width:16px; height:16px; cursor:pointer;" />
                            <i class="fas ${icon}" style="color:${color};"></i>
                            <div style="min-width:0;">
                                <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(name)}</div>
                                ${meta}
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="btn" type="button" onclick="deleteSharePointItem(event, '${payload}')" style="padding: 10px 12px; min-width: 46px;">
                                <span title="Delete"><i class="fas fa-trash"></i></span>
                            </button>
                            <button class="btn" type="button" onclick="selectSharePointFile(event, '${encodeURIComponent(url)}')" style="padding: 10px 12px; min-width: 92px;">
                                <span><i class="fas fa-check"></i> Use</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            el.innerHTML = folderHtml + fileHtml;
            
            // Update multi-selection controls
            updateSharePointSelection();
        }

        function formatBytes(bytes) {
            const n = Number(bytes);
            if (!Number.isFinite(n) || n < 0) return '';
            if (n === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.min(Math.floor(Math.log(n) / Math.log(1024)), units.length - 1);
            const value = n / Math.pow(1024, i);
            const digits = i === 0 ? 0 : (value >= 10 ? 1 : 2);
            return `${value.toFixed(digits)} ${units[i]}`;
        }

        function formatDateTime(dt) {
            const s = String(dt || '').trim();
            if (!s) return '';
            const d = new Date(s);
            if (isNaN(d.getTime())) return s;
            return d.toLocaleString();
        }

        function escapeHtml(s) {
            return String(s || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        async function browseSharePoint(folder) {
            // folder may arrive encoded from onclick
            let folderPath = folder;
            try {
                if (typeof folderPath === 'string' && folderPath.includes('%2F')) {
                    folderPath = decodeURIComponent(folderPath);
                }
            } catch (_) {}
            folderPath = (folderPath || spBrowseCurrent || '/').trim() || '/';

            setBrowsePath(folderPath);
            const listEl = document.getElementById('spBrowseList');
            if (listEl) listEl.innerHTML = '<div style="opacity:.8; font-size: 13px;">Loading…</div>';

            try {
                const qs = new URLSearchParams({ folder_path: folderPath });
                const response = await fetch('/api/sharepoint/browse?' + qs.toString(), { method: 'GET' });
                const data = await response.json();
                if (!response.ok) {
                    showResult('error', '<i class="fas fa-times-circle"></i> Failed to browse SharePoint: ' + (data.detail || 'Unknown error'));
                    if (listEl) listEl.innerHTML = '';
                    return;
                }
                setBrowsePath(data.path || folderPath);
                renderSharePointBreadcrumbs(data && data.breadcrumbs ? data.breadcrumbs : null, data.path || folderPath);
                renderBrowseList(data);
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Failed to browse SharePoint: ' + e.message);
                if (listEl) listEl.innerHTML = '';
            }
        }

        function setSharePointUploadSummary(text) {
            const summary = document.getElementById('spUploadSummary');
            if (!summary) return;
            summary.textContent = text || '';
        }

        function openSharePointUploadPicker() {
            // Single button UX: ask which picker to open.
            // OK -> folder upload, Cancel -> file upload.
            const folderMode = confirm('Upload a folder?\n\nOK = Choose folder (includes subfolders)\nCancel = Choose files');
            const input = document.getElementById(folderMode ? 'spUploadFolder' : 'spUploadFiles');
            if (!input) return;
            // Reset so choosing the same files/folder twice still fires change.
            try { input.value = ''; } catch (e) {}
            input.click();
        }

        function onSharePointUploadFilesSelected(evt) {
            const input = document.getElementById('spUploadFiles');
            const files = (input && input.files) ? Array.from(input.files) : [];
            if (!files.length) {
                setSharePointUploadSummary('No files selected');
                return;
            }
            setSharePointUploadSummary(files.length === 1 ? files[0].name : `${files.length} files selected`);
            uploadSharePointFiles(files, { preserveRelativePaths: false }).catch(() => {});
        }

        function onSharePointUploadFolderSelected(evt) {
            const input = document.getElementById('spUploadFolder');
            const files = (input && input.files) ? Array.from(input.files) : [];
            if (!files.length) {
                setSharePointUploadSummary('No folder selected');
                return;
            }
            const first = files[0];
            const root = (first && (first.webkitRelativePath || '').split('/')[0]) ? (first.webkitRelativePath.split('/')[0]) : 'folder';
            setSharePointUploadSummary(`${files.length} files from folder: ${root}`);
            uploadSharePointFiles(files, { preserveRelativePaths: true }).catch(() => {});
        }

        function _sharePointJoinPath(base, rel) {
            const a = String(base || '').trim() || '/';
            const b = String(rel || '').trim();
            if (!b) return a;
            const a2 = a.endsWith('/') ? a.slice(0, -1) : a;
            const b2 = b.startsWith('/') ? b.slice(1) : b;
            return (a2 || '/') + '/' + b2;
        }

        function _sharePointFolderForFile(baseFolder, file) {
            const rel = String((file && file.webkitRelativePath) ? file.webkitRelativePath : '').trim();
            if (!rel) return (String(baseFolder || '').trim() || '/');
            const clean = rel.replaceAll('\\', '/');
            const parts = clean.split('/').filter(Boolean);
            // parts: [rootFolder, ...subfolders, filename]
            if (parts.length <= 1) return (String(baseFolder || '').trim() || '/');
            // Include the root folder so SharePoint gets a real folder container.
            const folderRel = parts.slice(0, -1).join('/');
            return _sharePointJoinPath(baseFolder, folderRel);
        }

        async function uploadSharePointFiles(files, opts) {
            const preserveRelativePaths = !!(opts && opts.preserveRelativePaths);
            if (!files.length) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Please choose at least one file to upload.');
                return;
            }

            const baseFolder = (spBrowseCurrent || '/').trim() || '/';
            try {
                showResult('success', `<div><i class="fas fa-spinner fa-spin"></i> Uploading ${files.length} file(s) to ${escapeHtml(baseFolder)}…</div>`);

                const ensured = new Set();

                for (const f of files) {
                    const fd = new FormData();
                    const targetFolder = preserveRelativePaths ? _sharePointFolderForFile(baseFolder, f) : baseFolder;
                    fd.append('folder_path', targetFolder);
                    // Keep original filename; folder hierarchy is handled by folder_path.
                    fd.append('file', f, String((f && f.name) ? f.name : 'file'));

                    // Avoid redundant ensure calls on backend by clustering folder uploads.
                    if (preserveRelativePaths && targetFolder && !ensured.has(targetFolder)) {
                        ensured.add(targetFolder);
                    }
                    const resp = await fetch('/api/sharepoint/upload', { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok) {
                        throw new Error((data && data.detail) ? data.detail : 'Upload failed');
                    }
                }

                const inputFiles = document.getElementById('spUploadFiles');
                const inputFolder = document.getElementById('spUploadFolder');
                if (inputFiles) inputFiles.value = '';
                if (inputFolder) inputFolder.value = '';
                setSharePointUploadSummary('Upload completed');
                showResult('success', `<div><i class="fas fa-check-circle"></i> Upload completed.</div>`);
                await browseSharePoint(baseFolder);
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Upload failed: ' + escapeHtml(e.message || String(e)));
            }
        }

        async function deleteSharePointItem(evt, encodedPayload) {
            if (evt) evt.stopPropagation();
            let payloadRaw = '';
            try { payloadRaw = decodeURIComponent(encodedPayload || ''); } catch (_) { payloadRaw = encodedPayload || ''; }

            let payload = null;
            try { payload = JSON.parse(payloadRaw); } catch (_) { payload = null; }

            const url = String((payload && payload.path) ? payload.path : payloadRaw).trim();
            const name = String((payload && payload.name) ? payload.name : '').trim();
            const driveId = String((payload && payload.drive_id) ? payload.drive_id : '').trim();
            const itemId = String((payload && payload.item_id) ? payload.item_id : '').trim();

            if (!url && !(driveId && itemId)) return;

            const label = name ? name : url;
            const ok = confirm('Delete this item?\n\n' + label);
            if (!ok) return;

            try {
                const resp = await fetch('/api/sharepoint/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: url,
                        drive_id: driveId,
                        item_id: itemId
                    })
                });
                const data = await resp.json();
                if (!resp.ok || !(data && data.ok)) {
                    const msg = (data && (data.detail || data.error || data.message)) ? (data.detail || data.error || data.message) : 'Delete failed';
                    throw new Error(String(msg));
                }
                await browseSharePoint(spBrowseCurrent || '/');
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Delete failed: ' + escapeHtml(e.message || String(e)));
            }
        }

        // Multi-selection functions for SharePoint browser
        function updateSharePointSelection() {
            const checkboxes = document.querySelectorAll('.sp-item-checkbox');
            const checked = document.querySelectorAll('.sp-item-checkbox:checked');
            const countEl = document.getElementById('spSelectedCount');
            const barEl = document.getElementById('spMultiSelectBar');
            const selectAllEl = document.getElementById('spSelectAll');
            
            if (countEl) countEl.textContent = `${checked.length} selected`;
            if (barEl) barEl.style.display = checkboxes.length > 0 ? 'block' : 'none';
            if (selectAllEl) selectAllEl.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
        }

        function toggleSelectAllSharePoint(selectAll) {
            const checkboxes = document.querySelectorAll('.sp-item-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateSharePointSelection();
        }

        async function deleteSelectedSharePointItems() {
            const checked = document.querySelectorAll('.sp-item-checkbox:checked');
            if (checked.length === 0) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> No items selected.');
                return;
            }

            const items = [];
            checked.forEach(cb => {
                const payload = cb.getAttribute('data-payload');
                if (payload) {
                    try {
                        const decoded = decodeURIComponent(payload);
                        const parsed = JSON.parse(decoded);
                        items.push(parsed);
                    } catch (_) {}
                }
            });

            if (items.length === 0) return;

            const names = items.map(i => i.name || i.path || 'unknown').join('\n');
            const ok = confirm(`Delete ${items.length} item(s)?\n\n${names}`);
            if (!ok) return;

            let successCount = 0;
            let failCount = 0;
            const errors = [];

            for (const item of items) {
                try {
                    const resp = await fetch('/api/sharepoint/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            path: item.path || '',
                            drive_id: item.drive_id || '',
                            item_id: item.item_id || ''
                        })
                    });
                    const data = await resp.json();
                    if (!resp.ok || !(data && data.ok)) {
                        failCount++;
                        errors.push(`${item.name}: ${data.detail || data.error || 'Failed'}`);
                    } else {
                        successCount++;
                    }
                } catch (e) {
                    failCount++;
                    errors.push(`${item.name}: ${e.message || String(e)}`);
                }
            }

            // Reset selection
            const selectAllEl = document.getElementById('spSelectAll');
            if (selectAllEl) selectAllEl.checked = false;

            // Refresh the list
            await browseSharePoint(spBrowseCurrent || '/');

            // Show result
            if (failCount === 0) {
                showResult('success', `<i class="fas fa-check-circle"></i> Deleted ${successCount} item(s).`);
            } else if (successCount === 0) {
                showResult('error', `<i class="fas fa-times-circle"></i> Failed to delete all items.\n${errors.join('\n')}`);
            } else {
                showResult('warning', `<i class="fas fa-exclamation-triangle"></i> Deleted ${successCount}, failed ${failCount}.\n${errors.join('\n')}`);
            }
        }

        function browseSharePointUp() {
            const cur = (spBrowseCurrent || '/').replace(/\/+$/, '') || '/';
            if (cur === '/' || cur === '') {
                browseSharePoint('/');
                return;
            }
            const parts = cur.split('/').filter(Boolean);
            parts.pop();
            const parent = '/' + parts.join('/');
            browseSharePoint(parent || '/');
        }

        function selectSharePointFile(evt, encodedUrl) {
            if (evt) evt.stopPropagation();
            let url = '';
            try { url = decodeURIComponent(encodedUrl || ''); } catch (_) { url = encodedUrl || ''; }
            const input = document.getElementById('sharepointUrl');
            const folderInput = document.getElementById('sharepointFolder');
            if (input) input.value = url;
            // If using a full server-relative file path, folder becomes unnecessary.
            if (folderInput) folderInput.value = '';
        }

        async function processFolder() {
            const folderPath = document.getElementById('folderPath').value;

            if (!folderPath) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Please enter a folder path.');
                return;
            }

            // Save NETWORK_SHARE_DIR so Windows network path is persisted
            try {
                await fetch('/api/settings/network_share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: folderPath })
                });
            } catch (_) {
                // Non-fatal: continue to process even if save fails
            }

            const formData = new FormData();
            formData.append('folder_path', folderPath);

            showProgress(true);
            hideResult();

            try {
                const response = await fetch('/api/process-folder', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    let content = `<div class="result-title"><i class="fas fa-check-circle"></i> Completed successfully!</div>`;
                    content += `<div class="result-content">Processed ${data.results.length} PDF files</div>`;
                    
                    data.results.forEach((result, index) => {
                        content += `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 8px;">
                                <strong><i class="fas fa-file"></i> File ${index + 1}:</strong> ${result.filename}<br>
                                <a href="${result.download_url}" class="download-link" style="margin-top: 10px;">
                                    <i class="fas fa-download"></i> Download JSON
                                </a>
                            </div>
                        `;
                    });

                    showResult('success', content);
                } else {
                    showResult('error', '<i class="fas fa-times-circle"></i> ' + (data.detail || 'Processing failed'));
                }
            } catch (error) {
                showResult('error', '<i class="fas fa-times-circle"></i> Processing failed: ' + error.message);
            } finally {
                showProgress(false);
            }
        }

        async function saveNetworkShareDir() {
            const folderPath = document.getElementById('folderPath').value;

            if (!folderPath) {
                showResult('error', '<i class="fas fa-exclamation-circle"></i> Please enter a folder path.');
                return;
            }

            showProgress(true);
            try {
                const resp = await fetch('/api/settings/network_share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: folderPath })
                });

                if (resp.ok) {
                    showResult('success', '<i class="fas fa-check-circle"></i> Saved Windows folder (output).');
                } else {
                    let detail = resp.statusText;
                    try { const d = await resp.json(); if (d && d.detail) detail = d.detail; } catch(_){}
                    showResult('error', '<i class="fas fa-times-circle"></i> Save failed: ' + detail);
                }
            } catch (e) {
                showResult('error', '<i class="fas fa-times-circle"></i> Save failed: ' + e.message);
            } finally {
                showProgress(false);
            }
        }

        function generateTaskId() {
            return 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function connectWebSocket(taskId) {
            return new Promise((resolve, reject) => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/progress/${taskId}`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('[WebSocket] Connected:', taskId);
                    resolve();
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.percentage !== undefined) {
                            updateProgress(data.percentage, data.message || data.stage || 'Processing…');
                        }
                    } catch (e) {
                        console.error('[WebSocket] Failed to parse message:', e);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('[WebSocket] Connection error:', error);
                    // Don't reject; continue upload even if WebSocket fails.
                    resolve();
                };
                
                ws.onclose = () => {
                    console.log('[WebSocket] Closed');
                    ws = null;
                };
            });
        }
        
        function showProgress(show) {
            const progressDiv = document.getElementById('progress');
            if (progressDiv) {
                progressDiv.style.display = show ? 'block' : 'none';
            }
            if (!show) {
                currentProgress = 0;
                targetProgress = 0;
                isAnimating = false;
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
                updateProgress(0, 'Ready');
                // Close WebSocket
                if (ws) {
                    ws.close();
                    ws = null;
                }
            }
        }

        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const progressLabel = document.getElementById('progressLabel');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressFill) {
                const next = Math.max(0, Math.min(100, percentage));
                // UI-side monotonic progress protection (even if backend clamps)
                targetProgress = Math.max(targetProgress, next);
                
                // Smooth animation
                if (!isAnimating) {
                    animateProgress();
                }
            }

            if (progressLabel && typeof text === 'string') {
                progressLabel.textContent = text;
            }
            if (progressPercent) {
                progressPercent.textContent = `${Math.round(targetProgress)}%`;
            }
        }

        function animateProgress() {
            if (Math.abs(currentProgress - targetProgress) < 0.1) {
                currentProgress = targetProgress;
                isAnimating = false;
                return;
            }
            
            isAnimating = true;
            
            // Smooth transition (easing)
            const diff = targetProgress - currentProgress;
            currentProgress += diff * 0.15; // Adjust this value to change animation speed (0.1-0.3)
            
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = currentProgress + '%';
            }
            
            requestAnimationFrame(animateProgress);
        }

        function showResult(type, message, data = null) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';

            let content = '';
            if (typeof message === 'string') {
                content = `<div class="result-title">${message}</div>`;
            } else {
                content = message;
            }

            if (data && data.download_url) {
                content += `<div style="margin-top: 15px;">
                    <a href="${data.download_url}" class="download-link">
                        <i class="fas fa-download"></i> Download JSON file
                    </a>
                </div>`;

                content += `
                    <details class="upload-details" style="margin-top: 12px;">
                        <summary><i class="fas fa-code"></i> JSON preview</summary>
                        <div class="upload-details-body">
                            
                            <pre id="jsonPreview" style="margin-top:10px; max-height: 520px; overflow:auto; white-space: pre; background: rgba(255,255,255,0.55); padding: 12px; border-radius: 12px; font-size: 12px;">Loading…</pre>
                            <div id="jsonPreviewNote" style="margin-top:8px; font-size:12px; opacity:.8;"></div>
                        </div>
                    </details>
                `;
            }

            resultDiv.innerHTML = content;

            if (data && data.download_url) {
                loadAndRenderJsonPreview(data.download_url).catch((e) => {
                    const pre = document.getElementById('jsonPreview');
                    if (pre) pre.textContent = `Failed to load JSON preview: ${e?.message || String(e)}`;
                });
            }
        }

        let _lastJsonPreviewText = '';

        function escapeHtml(text) {
            return String(text)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function loadAndRenderJsonPreview(downloadUrl) {
            const pre = document.getElementById('jsonPreview');
            const note = document.getElementById('jsonPreviewNote');
            if (!pre) return;

            pre.textContent = 'Loading…';
            if (note) note.textContent = '';

            const resp = await fetch(downloadUrl, { cache: 'no-store' });
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }

            const rawText = await resp.text();
            const maxChars = 2_000_000;
            let text = rawText;
            let truncated = false;
            if (text.length > maxChars) {
                text = text.slice(0, maxChars);
                truncated = true;
            }

            // Try to pretty-print JSON when feasible
            let pretty = text;
            try {
                // Only attempt parse when not truncated to avoid confusing JSON.parse
                if (!truncated) {
                    const obj = JSON.parse(text);
                    pretty = JSON.stringify(obj, null, 2);
                }
            } catch {
                // Keep raw text
                pretty = text;
            }

            _lastJsonPreviewText = pretty;
            pre.textContent = pretty;
            if (note) {
                note.textContent = truncated
                    ? `Preview truncated to first ${maxChars.toLocaleString()} characters. Use “Download JSON file” for full output.`
                    : '';
            }
        }

        async function copyJsonPreview() {
            const text = _lastJsonPreviewText || '';
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
                const note = document.getElementById('jsonPreviewNote');
                if (note) note.textContent = 'Copied to clipboard.';
            } catch {
                // Fallback
                const pre = document.getElementById('jsonPreview');
                if (!pre) return;
                const range = document.createRange();
                range.selectNodeContents(pre);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand('copy');
                sel.removeAllRanges();
                const note = document.getElementById('jsonPreviewNote');
                if (note) note.textContent = 'Copied to clipboard.';
            }
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }
    </script>
</body>
</html>
