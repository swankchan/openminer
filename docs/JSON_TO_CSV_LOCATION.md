# Where JSON is Converted to CSV

## ğŸ“ File Locations

### 1. JSON sources

#### MinerU-generated JSON (when OCR is used)

- Location: `mineru_outputs/{pdf_name}/hybrid_{method}/`
- Files: `*.json`
- Description: JSON output generated by MinerU after processing a PDF
- Folder mapping:
  - `-m auto` â†’ `hybrid_auto/`
  - `-m ocr` â†’ `hybrid_ocr/`
  - `-m txt` â†’ `hybrid_txt/`
- Example: `mineru_outputs/document/hybrid_auto/*.json`

#### Directly-extracted JSON (when OCR is not needed)

- Location: in memory (not persisted to disk)
- Description: text is extracted directly from the PDF and converted into a JSON structure

### 2. CSV output location

- Directory (default): `outputs/`
- Override (optional): set `CSV_OUTPUT_DIR` in `.env`
- Filename format: `{file_id}.csv`
- Example full path: `C:\mineruocr\outputs\550e8400-e29b-41d4-a716-446655440000.csv`

## ğŸ”„ Conversion Flow

### Diagram

```
PDF file
    â†“
[Check whether OCR is needed]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OCR needed  â”‚  OCR not needed â”‚
â”‚   (use MinerU)  â”‚ (direct extract)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                    â†“
MinerU JSON         Direct JSON
(mineru_outputs/)   (in memory)
    â†“                    â†“

## ğŸ”„ Convert OpenAI JSON to CSV (local script)

If you have:

- A **raw OpenAI response dump** (Chat Completions or Responses API), or
- An **already-extracted structured JSON** (like invoice fields + `ItemTable`)

you can convert it directly to CSV using the helper script:

File: `scripts/openai_json_to_csv.py`

### Examples

```powershell
# 1) Convert extracted structured JSON (auto-flattens; auto-explodes ItemTable if present)
python scripts/openai_json_to_csv.py --input outputs\B2A1_Case1_20260114_063325.json --output outputs\B2A1_Case1_20260114_063325.csv

# 2) Force structured mode and explode a specific list field
python scripts/openai_json_to_csv.py --mode structured --explode ItemTable --input outputs\B2A1_Case1_20260114_063325.json --output outputs\invoice_items.csv

# 3) Convert raw OpenAI response dump (extracts response_text + usage; flattens JSON if the model output is JSON)
python scripts/openai_json_to_csv.py --mode openai_response --input my_openai_dump.json --output outputs\openai_dump.csv
```
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    [AzureAIService.generate_csv_from_json()]
             â†“
          CSV file
      (outputs/{file_id}.csv)
```

### Code locations

#### 1. Main call site

File: `main.py`
Function: `process_pdf_file()`
Lines: 193-196

```python
# Step 3: Generate CSV using Azure AI
csv_path = await azure_ai_service.generate_csv_from_json(
    mineru_json,
    CSV_OUTPUT_DIR / f"{file_id}.csv"
)
```

#### 2. Conversion logic

File: `services/azure_ai_service.py`
Function: `generate_csv_from_json()`
Lines: 42-96

Main paths:
- With Azure OpenAI: AI-based structured extraction (lines 59-91)
- Without Azure OpenAI: simple extraction (line 57 via `_simple_extraction`)

#### 3. Simple extraction helper

File: `services/azure_ai_service.py`
Function: `_simple_extraction()`
Lines: 162-197

Purpose: extract data directly from JSON and generate CSV

## ğŸ“‚ Directory Structure

```
mineruocr/
â”œâ”€â”€ mineru_outputs/          # MinerU JSON outputs (when OCR is used)
â”‚   â””â”€â”€ {pdf_name}/          # PDF file name (without extension)
â”‚       â””â”€â”€ hybrid_auto/     # Or hybrid_ocr, hybrid_txt (based on -m)
â”‚           â””â”€â”€ *.json
â”‚
â”œâ”€â”€ outputs/                 # Final CSV outputs â­
â”‚   â””â”€â”€ {file_id}.csv
â”‚
â””â”€â”€ services/
    â””â”€â”€ azure_ai_service.py  # JSON â†’ CSV conversion logic
```

## ğŸ” Details

### JSON format

Example MinerU JSON structure:

```json
{
  "document": {
    "pages": [
      {
        "page_number": 1,
        "text": "page text content",
        "elements": [],
        "tables": [],
        "figures": []
      }
    ],
    "total_pages": 1
  }
}
```

### CSV generation

1. With Azure OpenAI (if configured):
   - Analyze the JSON content
   - Use AI to extract structured data
   - Generate CSV

2. Simple extraction (if Azure OpenAI is not configured):
   - Extract from JSON `pages` and `elements`
   - Generate CSV with columns like "page", "type", "content"

### File ID generation

- Each uploaded PDF gets a unique `file_id` (UUID)
- The CSV filename uses this `file_id`
- Example: `550e8400-e29b-41d4-a716-446655440000.csv`

## ğŸ“ Examples

### List generated CSV files

```bash
# Windows PowerShell
Get-ChildItem outputs\*.csv

# Show the most recently generated CSV
Get-ChildItem outputs\*.csv | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

### Build the CSV path in code

```python
from config import CSV_OUTPUT_DIR
import uuid

file_id = str(uuid.uuid4())
csv_path = CSV_OUTPUT_DIR / f"{file_id}.csv"
```

## ğŸ¯ Summary

- JSON location:
  - MinerU JSON: `mineru_outputs/`
  - Or in memory (direct extraction)

- CSV location:
  - `outputs/{file_id}.csv`

- Conversion logic:
  - `services/azure_ai_service.py` `generate_csv_from_json()`

